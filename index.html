<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>Brewing Timer v5.2</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-bg: #1c1c1e;
            --card-active: #2c2c2e;
            --text-main: #ffffff;
            --text-sub: #8e8e93; 
            --accent-pour: #ff9f0a; /* Pour: Orange */
            --accent-steep: #0a84ff; /* Steep: Blue */
            --accent-steep-bg: rgba(10, 132, 255, 0.15); 
            --danger: #ff453a;
            --success: #30d158;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        header { 
            padding: 15px 15px; 
            text-align: center; 
            background-color: #000; 
            font-size: 1.1rem;
            font-weight: 800;
            color: #ffffff;
            border-bottom: 1px solid #1c1c1e;
            letter-spacing: -0.5px;
        }

        .tabs { display: flex; justify-content: space-around; background: #000; padding: 5px 0; border-bottom: 1px solid #1c1c1e; }
        .tab-btn { background: none; border: none; color: var(--text-sub); font-size: 0.9rem; font-weight: 500; padding: 12px 20px; transition: color 0.2s; cursor: pointer; }
        .tab-btn.active { color: var(--accent-pour); font-weight: 700; border-bottom: 2px solid var(--accent-pour); }

        main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        .view { display: none; width: 100%; height: 100%; flex-direction: column; }
        .view.active { display: flex; }

        .timer-layout { display: flex; flex-direction: column; height: 100%; padding: 15px 20px; }

        /* Meta Bar */
        .meta-bar-compact {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 4px 8px;
            margin-bottom: 15px;
            font-size: 0.72rem;
            color: var(--text-sub);
            background: #111;
            padding: 12px 8px;
            border-radius: 16px;
            flex-wrap: wrap;
            text-align: center;
        }
        .meta-item { display: inline-flex; align-items: center; white-space: nowrap; }
        .meta-val { color: #fff; font-weight: 600; margin-left: 3px; }
        .meta-sep { color: #333; font-size: 0.6rem; margin: 0 2px; font-weight: 300; }

        /* Timer Display */
        .timer-container { text-align: center; margin-bottom: 10px; }
        .main-timer-row { display: flex; align-items: center; justify-content: center; gap: 15px; }
        .step-countdown { font-size: 2.8rem; font-weight: 800; color: var(--text-main); font-variant-numeric: tabular-nums; }
        .timer-divider { font-size: 2rem; color: #333; font-weight: 300; }
        .total-elapsed { font-size: 2.8rem; font-weight: 800; color: var(--text-sub); font-variant-numeric: tabular-nums; }
        .timer-labels { display: flex; justify-content: center; gap: 60px; font-size: 0.65rem; color: var(--text-sub); text-transform: uppercase; margin-top: 4px; letter-spacing: 0.5px; }

        .cur-tip-display { text-align: center; height: 20px; margin: 10px 0; font-size: 0.8rem; color: var(--accent-pour); font-weight: 500; opacity: 0.9; }

        /* Timeline Bar */
        .timeline-wrapper { margin: 30px 0 50px 0; position: relative; }
        .timeline-container { width: 100%; height: 36px; background: #1c1c1e; border-radius: 6px; position: relative; border: 1px solid #333; }
        .step-progress-fill-container { position: absolute; top: 0; height: 100%; z-index: 1; }
        .step-progress-fill-container.steep-zone { background-color: var(--accent-steep-bg); }
        .step-progress-fill { position: absolute; top: 0; height: 100%; width: 0%; transition: width 0.1s linear; }
        .fill-pour { background: var(--accent-pour); }
        .fill-steep { background: var(--accent-steep); }
        .step-block { position: absolute; top: 0; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 2; pointer-events: none; }
        .step-water-label { font-size: 0.75rem; font-weight: 800; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .step-name-label { position: absolute; top: 42px; font-size: 0.65rem; font-weight: 700; color: var(--text-sub); white-space: nowrap; transform: translateX(-50%); left: 50%; transition: color 0.3s; }
        .step-name-label.active-pour { color: var(--accent-pour); }
        .step-name-label.active-steep { color: var(--accent-steep); }
        .step-divider { position: absolute; top: -5px; bottom: -5px; width: 2px; background: rgba(255,255,255,0.3); z-index: 4; }
        .divider-label-top { position: absolute; top: -24px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 800; color: var(--success); white-space: nowrap; }
        .divider-label-bottom { position: absolute; bottom: -24px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; font-weight: 600; color: var(--text-sub); white-space: nowrap; }

        /* Water Info */
        .water-stats { display: flex; justify-content: space-around; margin-bottom: 15px; background: #111; padding: 14px; border-radius: 20px; }
        .water-item { text-align: center; }
        .water-label { font-size: 0.7rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 4px; }
        .water-val-big { font-size: 1.8rem; font-weight: 800; color: var(--success); line-height: 1; }
        .water-val-total { font-size: 1.5rem; font-weight: 700; color: var(--accent-pour); line-height: 1; }

        /* Next Step Info */
        .next-step-card { background: var(--card-active); border-radius: 20px; padding: 18px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; border: 1px solid #333; }
        .next-tag { font-size: 0.75rem; color: var(--accent-pour); font-weight: 800; margin-bottom: 6px; letter-spacing: 1px; }
        .next-title { font-size: 1.4rem; font-weight: 900; color: #fff; margin-bottom: 4px; line-height: 1.2; }
        .next-desc { font-size: 0.85rem; color: var(--text-sub); font-weight: 500; }
        .cur-step-footer { margin-top: 10px; font-size: 0.85rem; color: #444; text-align: center; }

        /* Controls */
        .controls { display: flex; gap: 10px; margin-top: 15px; }
        .btn { padding: 16px; border-radius: 16px; border: none; font-size: 1rem; font-weight: 700; cursor: pointer; flex: 1; transition: opacity 0.2s; }
        .btn:active { opacity: 0.7; }
        .btn-start { background-color: var(--accent-pour); color: #000; }
        .btn-stop { background-color: var(--danger); color: #fff; display: none; }
        .btn-reset { background-color: #333; color: #fff; flex: 0.4; }
        
        /* Editor */
        .editor-container { padding: 20px; padding-bottom: 120px; }
        .recipe-item { background: var(--card-bg); padding: 12px; margin-bottom: 12px; border-radius: 10px; border: 1px solid #333; }
        .recipe-grid { display: grid; grid-template-columns: 1.2fr 1fr 0.8fr 0.8fr 30px; gap: 8px; align-items: start; margin-bottom: 8px; }
        input, select { background: #2c2c2e; border: 1px solid #3a3a3c; color: #fff; padding: 10px; border-radius: 8px; width: 100%; font-size: 0.9rem; }
        label { font-size: 0.7rem; color: var(--text-sub); margin-bottom: 4px; display: block; }

        /* Overlay */
        .countdown-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .countdown-num { font-size: 10rem; font-weight: 900; color: var(--accent-pour); }

        /* Share/Library UI */
        .lib-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .lib-btn { background: #333; color: #fff; border: none; padding: 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .lib-btn-primary { background: var(--accent-pour); color: #000; }
        .share-btn { background: #2c2c2e; border: none; color: #fff; padding: 6px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; }

        /* Modal simple */
        #customModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 400px; padding: 25px; border-radius: 24px; text-align: center; border: 1px solid #333; }
        .modal-input { margin: 15px 0; background: #000; color: #fff; border: 1px solid #444; padding: 12px; width: 100%; border-radius: 8px; font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body>

<header id="appTitleHeader">브루잉 타이머</header>

<div id="countdownBox" class="countdown-overlay">
    <div id="startCountText" class="countdown-num">3</div>
</div>

<!-- Modal for Import/Export -->
<div id="customModal" onclick="if(event.target === this) closeM()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h4 id="modalTitle" style="margin:0 0 10px 0;">레시피 코드</h4>
        <p id="modalDesc" style="font-size: 0.8rem; color: var(--text-sub); margin-bottom: 15px;">코드를 복사하여 공유하세요.</p>
        <textarea id="modalInput" class="modal-input" rows="4" spellcheck="false"></textarea>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn" style="background:#333; color:#fff;" onclick="closeM()">닫기</button>
            <button id="modalPrimaryBtn" class="btn" style="background:var(--accent-pour); color:#000;">확인</button>
        </div>
    </div>
</div>

<main>
    <div id="view-timer" class="view active">
        <div class="timer-layout">
            <div class="meta-bar-compact">
                <span class="meta-item">원두 <span id="dispCoffee" class="meta-val">--</span></span>
                <span class="meta-sep">|</span>
                <span class="meta-item">분쇄도 <span id="dispGrind" class="meta-val">--</span></span>
                <span class="meta-sep">|</span>
                <span class="meta-item">온도 <span id="dispTemp" class="meta-val">--</span></span>
                <span class="meta-sep">|</span>
                <span class="meta-item">물 <span id="dispTotalWater" class="meta-val">--</span></span>
                <span class="meta-sep">|</span>
                <span class="meta-item">도구 <span id="dispDripper" class="meta-val">--</span></span>
            </div>

            <div class="timer-container">
                <div class="main-timer-row">
                    <div class="step-countdown" id="stepCountdown">0:00</div>
                    <div class="timer-divider">/</div>
                    <div class="total-elapsed" id="totalTime">0:00</div>
                </div>
                <div class="timer-labels"><span>남은 단계</span><span>총 경과</span></div>
            </div>

            <div class="cur-tip-display" id="curTipDisplay"></div>
            <div class="timeline-wrapper"><div class="timeline-container" id="timelineBox"></div></div>

            <div class="water-stats">
                <div class="water-item"><div class="water-label">현재 목표</div><div class="water-val-big"><span id="liveWaterTarget">0</span><small>g</small></div></div>
                <div class="water-item"><div class="water-label">누적 목표</div><div class="water-val-total"><span id="targetWaterTotal">0</span><small>g</small></div></div>
            </div>

            <div class="next-step-card" id="nextStepBox">
                <div class="next-tag" id="nextStepTag">다음 단계</div>
                <div class="next-title" id="nextStepAction">준비됨</div>
                <div class="next-desc" id="nextStepName">추출 시작 대기</div>
            </div>
            <div class="cur-step-footer"><span id="curStepNameDisplay">대기 중</span></div>

            <div class="controls">
                <button class="btn btn-reset" onclick="resetTimer()">리셋</button>
                <button class="btn btn-start" id="btnStart" onclick="handleStart()">추출 시작</button>
                <button class="btn btn-stop" id="btnStop" onclick="pauseTimer()">일시 정지</button>
            </div>
        </div>
    </div>

    <div id="view-editor" class="view">
        <div class="editor-container">
            <h3>레시피 설정</h3>
            <div style="background:var(--card-bg); padding:15px; border-radius:12px; margin-bottom:20px; display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div style="grid-column: span 2;"><label>레시피 이름</label><input type="text" id="recipeName" onchange="updateMeta()"></div>
                <div><label>원두 (g)</label><input type="number" id="editCoffee" onchange="updateMeta()"></div>
                <div><label>분쇄도 (클릭)</label><input type="number" id="editGrind" onchange="updateMeta()"></div>
                <div><label>온도 (°C)</label><input type="number" id="editTemp" onchange="updateMeta()"></div>
                <div><label>추출 도구</label><input type="text" id="editDripper" onchange="updateMeta()"></div>
            </div>
            <h3>가이드 편집</h3>
            <div id="stepList"></div>
            <button class="btn" style="background:var(--success); color:#fff; width:100%; margin:10px 0;" onclick="addStep()">+ 단계 추가</button>
            
            <div id="savedList"></div>
        </div>
    </div>
</main>

<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('timer')">타이머</button>
    <button class="tab-btn" onclick="switchTab('editor')">보관함/설정</button>
</div>

<script>
    const KEY_META = 'brew_recipe_meta_v51';
    const KEY_STEPS = 'brew_recipe_steps_v51';
    const KEY_LIB = 'brew_recipe_library_v51';

    let recipeMeta = JSON.parse(localStorage.getItem(KEY_META)) || { coffee: 20, temp: 92, grind: 24, dripper: "V60", name: "기본 레시피" };
    let steps = JSON.parse(localStorage.getItem(KEY_STEPS)) || [
        { name: "뜸", method: "푸어", time: 40, water: 40, tip: "골고루 적시기" },
        { name: "1차", method: "푸어", time: 60, water: 120, tip: "원형으로 푸어링" },
        { name: "2차", method: "푸어", time: 60, water: 140, tip: "마무리 푸어링" }
    ];
    let recipeLibrary = JSON.parse(localStorage.getItem(KEY_LIB)) || [];
    
    let timerIdx = null, startTs = 0, elapsed = 0, running = false, lastSpokenIdx = -1;
    const synth = window.speechSynthesis;

    function openM(title, desc, btnText, btnFn) {
        document.getElementById('modalTitle').innerText = title;
        document.getElementById('modalDesc').innerText = desc;
        document.getElementById('modalInput').value = "";
        const pBtn = document.getElementById('modalPrimaryBtn');
        pBtn.innerText = btnText;
        pBtn.onclick = btnFn;
        document.getElementById('customModal').style.display = 'flex';
    }
    function closeM() { document.getElementById('customModal').style.display = 'none'; }

    function speak(text) {
        if(!text) return; 
        synth.cancel();
        let p = text.replace(/1차/g, "일차").replace(/2차/g, "이차").replace(/3차/g, "삼차");
        let u = new SpeechSynthesisUtterance(p); u.lang = 'ko-KR';
        synth.speak(u);
    }

    async function handleStart() {
        if(running) return;
        if(elapsed > 0) { startTimer(); return; }
        const overlay = document.getElementById('countdownBox');
        overlay.style.display = 'flex';
        let count = 3; speak(count.toString());
        const i = setInterval(() => {
            count--; if(count > 0) { document.getElementById('startCountText').innerText = count; speak(count.toString()); }
            else { clearInterval(i); overlay.style.display = 'none'; speak("추출 시작"); startTimer(); }
        }, 1000);
    }

    function startTimer() { running = true; startTs = Date.now() - (elapsed * 1000); timerIdx = setInterval(update, 100); document.getElementById('btnStart').style.display = 'none'; document.getElementById('btnStop').style.display = 'block'; }
    function pauseTimer() { running = false; clearInterval(timerIdx); document.getElementById('btnStart').style.display = 'block'; document.getElementById('btnStop').style.display = 'none'; document.getElementById('btnStart').innerText = "재개"; }
    function resetTimer() { pauseTimer(); elapsed = 0; lastSpokenIdx = -1; updateUI(0); document.getElementById('btnStart').innerText = "추출 시작"; }
    function update() { elapsed = (Date.now() - startTs) / 1000; updateUI(elapsed); }

    function updateUI(totalSec) {
        const totalTimeMax = steps.reduce((a,b) => a + parseInt(b.time), 0);
        let accTime = 0, cur = null, next = null, curIdx = -1;
        for(let i=0; i<steps.length; i++){
            let t = parseInt(steps[i].time); const fillEl = document.getElementById(`fill-${i}`);
            if(totalSec < accTime + t) { if (curIdx === -1) { cur = steps[i]; curIdx = i; if(i+1 < steps.length) next = steps[i+1]; if (fillEl) fillEl.style.width = Math.min(100, ((totalSec - accTime) / t) * 100) + "%"; } else if (fillEl) fillEl.style.width = "0%"; }
            else { if (fillEl) fillEl.style.width = "100%"; }
            accTime += t;
        }
        document.getElementById('totalTime').innerText = formatTime(Math.floor(totalSec));
        document.querySelectorAll('.step-name-label').forEach((label, idx) => { label.classList.remove('active-pour', 'active-steep'); if(idx === curIdx) label.classList.add(cur.method === '푸어' ? 'active-pour' : 'active-steep'); });
        if(cur) {
            const stepStartTime = steps.slice(0, curIdx).reduce((acc, s) => acc + parseInt(s.time), 0);
            const stepRem = Math.max(0, parseInt(cur.time) - (totalSec - stepStartTime));
            if(curIdx !== lastSpokenIdx) { speak(`${cur.name}. ${cur.water}그램.`); lastSpokenIdx = curIdx; }
            document.getElementById('stepCountdown').innerText = formatTime(Math.ceil(stepRem));
            document.getElementById('liveWaterTarget').innerText = cur.water;
            document.getElementById('curTipDisplay').innerText = cur.tip || "";
            let currentTargetTotal = 0; for(let j=0; j<=curIdx; j++) currentTargetTotal += parseInt(steps[j].water);
            document.getElementById('targetWaterTotal').innerText = currentTargetTotal;
            document.getElementById('curStepNameDisplay').innerText = `진행 중: ${cur.name}`;
            if(next) {
                document.getElementById('nextStepTag').style.color = next.method === '푸어' ? 'var(--accent-pour)' : 'var(--accent-steep)';
                document.getElementById('nextStepAction').innerText = `${next.name} - ${next.water}g`;
                document.getElementById('nextStepName').innerText = `${next.tip ? next.tip + ' / ' : ''}${formatTime(Math.ceil(stepRem))} 후`;
            } else { document.getElementById('nextStepAction').innerText = "추출 완료 대기"; }
        } else if(totalSec >= totalTimeMax && steps.length > 0) {
            document.getElementById('stepCountdown').innerText = "0:00";
            document.getElementById('nextStepAction').innerText = "완료";
            if(running) { speak("추출이 완료되었습니다."); pauseTimer(); }
        }
    }

    function renderTimeline() {
        const box = document.getElementById('timelineBox'); box.innerHTML = ''; 
        const totalT = steps.reduce((a,b) => a + parseInt(b.time), 0);
        let accT = 0, accW = 0;
        steps.forEach((s, i) => {
            const width = (parseInt(s.time) / totalT) * 100; const left = (accT / totalT) * 100;
            accW += parseInt(s.water); accT += parseInt(s.time);
            const fillC = document.createElement('div'); fillC.className = 'step-progress-fill-container' + (s.method === '침출' ? ' steep-zone' : '');
            fillC.style.left = left + "%"; fillC.style.width = width + "%";
            const fill = document.createElement('div'); fill.id = `fill-${i}`; fill.className = `step-progress-fill ${s.method === '침출' ? 'fill-steep' : 'fill-pour'}`;
            fillC.appendChild(fill); box.appendChild(fillC);
            const block = document.createElement('div'); block.className = 'step-block'; block.style.left = left + "%"; block.style.width = width + "%";
            block.innerHTML = `<span class="step-water-label">${s.water}g</span><span class="step-name-label">${s.name}</span>`;
            box.appendChild(block);
            const div = document.createElement('div'); div.className = 'step-divider'; div.style.left = ((accT / totalT) * 100) + "%";
            div.innerHTML = `<div class="divider-label-top">${accW}g</div><div class="divider-label-bottom">${formatTime(accT)}</div>`;
            box.appendChild(div);
        });
    }

    function formatTime(s) { const m = Math.floor(s/60).toString(); const sc = (s%60).toString().padStart(2,'0'); return `${m}:${sc}`; }

    function updateMeta() {
        recipeMeta.coffee = document.getElementById('editCoffee').value; recipeMeta.temp = document.getElementById('editTemp').value;
        recipeMeta.grind = document.getElementById('editGrind').value; recipeMeta.dripper = document.getElementById('editDripper').value;
        recipeMeta.name = document.getElementById('recipeName').value;
        const tw = steps.reduce((acc, s) => acc + parseInt(s.water), 0);
        document.getElementById('dispCoffee').innerText = recipeMeta.coffee + "g";
        document.getElementById('dispGrind').innerText = recipeMeta.grind + "클릭";
        document.getElementById('dispTemp').innerText = recipeMeta.temp + "°C";
        document.getElementById('dispTotalWater').innerText = tw + "g";
        document.getElementById('dispDripper').innerText = recipeMeta.dripper || "--";
        document.getElementById('appTitleHeader').innerText = recipeMeta.name;
        localStorage.setItem(KEY_META, JSON.stringify(recipeMeta)); localStorage.setItem(KEY_STEPS, JSON.stringify(steps));
        renderTimeline();
    }

    function renderStepEditor() {
        const list = document.getElementById('stepList');
        list.innerHTML = steps.map((s, i) => `
            <div class="recipe-item">
                <div class="recipe-grid">
                    <div><label>명칭</label><input type="text" value="${s.name}" onchange="steps[${i}].name=this.value; updateMeta();"></div>
                    <div><label>방식</label><select onchange="steps[${i}].method=this.value; updateMeta();"><option value="푸어" ${s.method==='푸어'?'selected':''}>푸어</option><option value="침출" ${s.method==='침출'?'selected':''}>침출</option></select></div>
                    <div><label>물(g)</label><input type="number" value="${s.water}" onchange="steps[${i}].water=this.value; updateMeta();"></div>
                    <div><label>시간(s)</label><input type="number" value="${s.time}" onchange="steps[${i}].time=this.value; updateMeta();"></div>
                    <button onclick="deleteStep(${i})" style="color:var(--danger); background:none; border:none; font-size:1.5rem; margin-top:20px;">&times;</button>
                </div>
                <div style="width:100%"><label>단계별 팁</label><input type="text" value="${s.tip || ''}" onchange="steps[${i}].tip=this.value; updateMeta();"></div>
            </div>`).join('');
        updateMeta(); renderLibrary();
    }

    function addStep() { steps.push({name:"추가", method:"푸어", time:30, water:50, tip:""}); renderStepEditor(); }
    function deleteStep(i) { steps.splice(i,1); renderStepEditor(); }

    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById('view-'+id).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(id==='timer') { document.querySelectorAll('.tab-btn')[0].classList.add('active'); renderTimeline(); updateUI(elapsed); }
        else { document.querySelectorAll('.tab-btn')[1].classList.add('active'); renderStepEditor(); }
    }

    function renderLibrary() {
        const list = document.getElementById('savedList');
        list.innerHTML = `
            <h3 style="margin-top:30px; border-top:1px solid #222; padding-top:20px;">레시피 보관함</h3>
            <div class="lib-actions">
                <button class="lib-btn lib-btn-primary" onclick="saveToLib()">현재 레시피 저장</button>
                <button class="lib-btn" onclick="triggerImport()">불러오기</button>
            </div>
            <div id="libItems"></div>`;
        const itemsBox = document.getElementById('libItems');
        if (recipeLibrary.length === 0) itemsBox.innerHTML = '<p style="color:#555; text-align:center; font-size:0.8rem;">저장된 레시피가 없습니다.</p>';
        else itemsBox.innerHTML = recipeLibrary.map((item, idx) => `
            <div style="background:#111; padding:15px; border-radius:12px; margin-bottom:12px; border:1px solid #222;">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px;">
                    <div><div style="font-weight:700; color:#fff;">${item.meta.name}</div><div style="font-size:0.7rem; color:#666;">${item.meta.dripper || '도구'} / ${item.meta.coffee}g / ${item.steps.reduce((acc,s)=>acc+parseInt(s.water),0)}g</div></div>
                    <button onclick="deleteFromLib(${idx})" style="color:var(--danger); background:none; border:none; font-size:1.2rem;">&times;</button>
                </div>
                <div style="display:flex; gap:8px;">
                    <button onclick="loadFromLib(${idx})" style="flex:1; background:var(--accent-steep); color:#fff; border:none; padding:8px; border-radius:8px; font-weight:700; font-size:0.8rem;">로드</button>
                    <button onclick="exportRecipe(${idx})" class="share-btn">공유</button>
                </div>
            </div>`).join('');
    }
    
    function saveToLib() { recipeLibrary.push({ meta: JSON.parse(JSON.stringify(recipeMeta)), steps: JSON.parse(JSON.stringify(steps)) }); localStorage.setItem(KEY_LIB, JSON.stringify(recipeLibrary)); renderLibrary(); }
    function loadFromLib(idx) { 
        recipeMeta = JSON.parse(JSON.stringify(recipeLibrary[idx].meta)); steps = JSON.parse(JSON.stringify(recipeLibrary[idx].steps)); 
        document.getElementById('editCoffee').value = recipeMeta.coffee; document.getElementById('editTemp').value = recipeMeta.temp;
        document.getElementById('editGrind').value = recipeMeta.grind; document.getElementById('recipeName').value = recipeMeta.name;
        document.getElementById('editDripper').value = recipeMeta.dripper || "";
        renderStepEditor(); switchTab('timer'); 
    }
    function deleteFromLib(idx) { recipeLibrary.splice(idx, 1); localStorage.setItem(KEY_LIB, JSON.stringify(recipeLibrary)); renderLibrary(); }

    /* Share Features */
    function exportRecipe(idx) {
        const item = recipeLibrary[idx];
        const code = btoa(encodeURIComponent(JSON.stringify(item)));
        openM("레시피 공유", "아래 코드를 복사하여 친구에게 전달하세요.", "복사하기", () => {
            const area = document.getElementById('modalInput'); area.select();
            document.execCommand('copy'); alert('코드가 클립보드에 복사되었습니다.'); closeM();
        });
        document.getElementById('modalInput').value = code;
    }
    function triggerImport() {
        openM("레시피 불러오기", "전달받은 레시피 코드를 아래에 붙여넣으세요.", "불러오기", () => {
            const code = document.getElementById('modalInput').value.trim();
            if(!code) return;
            try {
                const decoded = JSON.parse(decodeURIComponent(atob(code)));
                recipeLibrary.push(decoded); localStorage.setItem(KEY_LIB, JSON.stringify(recipeLibrary));
                renderLibrary(); alert('성공적으로 불러왔습니다!'); closeM();
            } catch(e) { alert('유효하지 않은 코드입니다.'); }
        });
    }

    window.onload = () => {
        document.getElementById('editCoffee').value = recipeMeta.coffee; document.getElementById('editTemp').value = recipeMeta.temp;
        document.getElementById('editGrind').value = recipeMeta.grind; document.getElementById('recipeName').value = recipeMeta.name;
        document.getElementById('editDripper').value = recipeMeta.dripper || "";
        updateMeta(); renderTimeline(); updateUI(0);
    };
</script>
</body>
</html>
