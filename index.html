<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#121212">
    <title>Brewing Timer v1.0</title>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #aaaaaa; 
            --text-dim: #888888;
            --accent: #d4a373; 
            --danger: #ef4444;
            --success: #22c55e;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        header { 
            padding: 15px; 
            text-align: center; 
            background-color: var(--card-bg); 
            border-bottom: 1px solid #333;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .tabs { display: flex; justify-content: space-around; background: #000; padding: 10px 0; border-bottom: 1px solid #333; }
        .tab-btn { background: none; border: none; color: var(--text-dim); font-size: 1rem; font-weight: 600; padding: 10px 20px; }
        .tab-btn.active { color: var(--accent); border-bottom: 2px solid var(--accent); }

        main { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .view { display: none; width: 100%; height: 100%; }
        .view.active { display: flex; flex-direction: column; }

        .info-card {
            background-color: var(--card-bg); 
            border-radius: 20px; 
            padding: 25px 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }

        .weight-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: baseline;
            margin-top: 10px;
        }

        .weight-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .water-highlight { color: var(--success); font-weight: 900; font-size: 2.8rem; line-height: 1; }
        .total-water-highlight { color: var(--accent); font-weight: 900; font-size: 2.8rem; line-height: 1; }

        .step-tip {
            margin-top: 20px;
            font-size: 1.75rem; 
            color: var(--text-sub);
            font-weight: 600;
            min-height: 2.1rem; 
            word-break: keep-all;
        }

        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 15px;
        }

        .time-row {
            text-align: center;
            width: 100%;
        }

        .time-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .big-time-font {
            font-size: 4.5rem; 
            font-weight: 800;
            line-height: 1;
            font-variant-numeric: tabular-nums;
            letter-spacing: -2px;
        }

        .total-time-val { color: var(--accent); }

        .step-time-display {
            font-size: 2.5rem; 
            font-weight: 700;
            color: var(--text-sub);
            font-variant-numeric: tabular-nums;
        }

        .countdown-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .countdown-num { font-size: 10rem; font-weight: 900; color: var(--accent); }

        .step-name { font-size: 1.8rem; font-weight: 800; margin-bottom: 15px; color: #fff; }

        .controls { display: flex; gap: 12px; margin-top: 20px; width: 100%; margin-bottom: 10px; }
        .btn { padding: 18px; border-radius: 16px; border: none; font-size: 1.1rem; font-weight: 700; cursor: pointer; flex: 1; }
        .btn-start { background-color: var(--accent); color: #000; }
        .btn-stop { background-color: var(--danger); color: #fff; display: none; }
        .btn-reset { background-color: #333; color: #fff; flex: 0.4; }

        .recipe-item { 
            background: var(--card-bg); 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 12px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .recipe-row-1 {
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr 40px; 
            gap: 8px; 
            align-items: center; 
        }
        .recipe-row-2 {
            display: flex;
        }
        
        input, select { 
            background: #2a2a2a; 
            border: 1px solid #333; 
            color: #fff; 
            padding: 10px 5px; 
            border-radius: 8px; 
            width: 100%; 
            font-size: 0.9rem;
            text-align: center;
        }
        input[type="text"] { text-align: left; }
        
        .log-entry { 
            background: var(--card-bg);
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid var(--accent);
        }

        .saved-recipes { margin-top: 30px; border-top: 1px solid #333; padding-top: 20px; }
        .saved-item {
            display: flex; justify-content: space-between; align-items: center;
            background: #252525; padding: 15px; border-radius: 10px; margin-bottom: 8px;
        }
        .saved-title { font-weight: bold; font-size: 1rem; }
        .saved-actions button { margin-left: 5px; padding: 8px 12px; font-size: 0.9rem; border-radius: 6px; cursor: pointer; border: none; }
        .btn-load { background: #444; color: #fff; }
        .btn-del { background: #330000; color: var(--danger); }
    </style>
</head>
<body>

<header id="app-header">Brewing Timer v1.0</header>
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('timer')">타이머</button>
    <button class="tab-btn" onclick="switchTab('editor')">레시피</button>
    <button class="tab-btn" onclick="switchTab('logs')">기록</button>
</div>

<div id="countdownBox" class="countdown-overlay">
    <div style="font-size: 1.5rem; color: #fff; margin-bottom: 20px;">준비하세요!</div>
    <div id="countdownText" class="countdown-num">5</div>
</div>

<main>
    <div id="view-timer" class="view active">
        <div class="info-card" id="stepBox">
            <div class="step-name" id="curStepName">준비</div>
            <div class="weight-row">
                <div>
                    <div class="weight-label">이번 투입</div>
                    <span class="water-highlight" id="curWater">0g</span>
                </div>
                <div style="color: #444; font-size: 2.5rem; font-weight: 300;">/</div>
                <div>
                    <div class="weight-label">누적 목표</div>
                    <span class="total-water-highlight" id="totalWater">0g</span>
                </div>
            </div>
            <div class="step-tip" id="curStepTip"></div>
        </div>

        <div class="timer-container">
            <div class="time-row">
                <div class="time-label">Total Elapsed</div>
                <div class="big-time-font total-time-val" id="totalTime">00:00</div>
            </div>

            <div class="time-row">
                <div class="time-label">Step Progress</div>
                <div id="stepTimeContainer" class="step-time-display">
                    <span id="stepTimeCurrent">00:00</span>
                    <span style="color: #444; margin: 0 5px;">/</span>
                    <span id="stepTimeTarget" style="color: #444;">00:00</span>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn btn-reset" onclick="resetTimer()">리셋</button>
            <button class="btn btn-start" id="btnStart" onclick="handleStart()">추출 시작</button>
            <button class="btn btn-stop" id="btnStop" onclick="pauseTimer()">일시 정지</button>
        </div>
    </div>

    <div id="view-editor" class="view">
        <div style="color:#888; margin-bottom:10px; font-size:0.8rem; text-align:center;">
            단계명 / 방법 / 물(g) / 시간(초) + 팁(Tip)
        </div>
        <div id="recipeList"></div>
        <button class="btn" style="background:var(--success); color:#fff; margin-top:10px; width:100%;" onclick="addStep()">+ 단계 추가</button>
        
        <div class="saved-recipes">
            <h3 style="color:#fff; margin-bottom:10px;">레시피 보관함</h3>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <input type="text" id="recipeNameInput" placeholder="레시피 이름 (예: 아이스 드립)" style="flex:1; text-align:left;">
                <button class="btn" style="background:var(--accent); color:#000; flex:0.4; padding:10px;" onclick="saveToLibrary()">보관함 저장</button>
            </div>
            <div id="savedList"></div>
        </div>
    </div>

    <div id="view-logs" class="view">
        <input type="text" id="logBean" placeholder="원두 정보 입력" style="margin-bottom:15px; padding: 15px;">
        <button class="btn btn-start" onclick="saveLog()" style="width:100%;">기록 저장</button>
        <div id="logHistory" style="margin-top:20px;"></div>
    </div>
</main>

<script>
    let recipe = JSON.parse(localStorage.getItem('activeRecipe_v4')) || [
        { name: "뜸 들이기", method: "푸어", time: 35, water: 40, tip: "골고루 적셔주세요" },
        { name: "1차 추출", method: "푸어", time: 60, water: 80, tip: "천천히 부어주세요" },
        { name: "2차 추출", method: "침출", time: 60, water: 80, tip: "스위치 닫고 대기" }
    ];
    
    let recipeLibrary = JSON.parse(localStorage.getItem('recipeLibrary_v4')) || [];
    let logs = JSON.parse(localStorage.getItem('brewLogs_v4')) || [];
    let timerIdx = null, startTs = 0, elapsed = 0, running = false;
    let wakeLock = null;
    let warnedImmersionStart = -1; 
    let warnedImmersionEnd = -1;   

    const synth = window.speechSynthesis;
    let targetVoice = null;

    function loadVoices() {
        const voices = synth.getVoices();
        targetVoice = voices.find(v => v.lang === 'ko-KR' && v.name.includes('Google')) ||
                      voices.find(v => v.lang === 'ko-KR');
    }
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = loadVoices;
    }
    loadVoices();

    function speak(text) {
        synth.cancel();
        let u = new SpeechSynthesisUtterance(text);
        u.lang = 'ko-KR';
        if (targetVoice) u.voice = targetVoice;
        u.rate = 0.95; 
        u.pitch = 1.0; 
        synth.speak(u);
    }

    async function handleStart() {
        if(running) return;
        if(elapsed > 0) {
            startTimer();
            return;
        }

        const overlay = document.getElementById('countdownBox');
        const text = document.getElementById('countdownText');
        overlay.style.display = 'flex';
        
        let count = 5;
        text.innerText = count;
        speak(count.toString());

        const countInterval = setInterval(() => {
            count--;
            if(count > 0) {
                text.innerText = count;
                speak(count.toString());
            } else {
                clearInterval(countInterval);
                overlay.style.display = 'none';
                startTimer();
            }
        }, 1000);
    }

    async function startTimer() {
        if(!running) {
            speak(""); 
            running = true;
            startTs = Date.now() - (elapsed * 1000);
            timerIdx = setInterval(update, 100);
            document.getElementById('btnStart').style.display = 'none';
            document.getElementById('btnStop').style.display = 'block';
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (e) {}
            }
        }
    }

    function pauseTimer() {
        running = false;
        clearInterval(timerIdx);
        document.getElementById('btnStart').style.display = 'block';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('btnStart').innerText = "재개";
        if(wakeLock) { wakeLock.release(); wakeLock = null; }
    }

    function resetTimer() {
        pauseTimer(); 
        elapsed = 0;
        warnedImmersionStart = -1;
        warnedImmersionEnd = -1;
        document.getElementById('totalTime').innerText = "00:00";
        document.getElementById('stepTimeCurrent').innerText = "00:00";
        document.getElementById('stepTimeTarget').innerText = "00:00";
        document.getElementById('curStepName').innerText = "준비";
        document.getElementById('curWater').innerText = "0g";
        document.getElementById('totalWater').innerText = "0g";
        document.getElementById('curStepTip').innerText = ""; 
        document.getElementById('btnStart').innerText = "추출 시작";
    }

    function update() {
        elapsed = Math.floor((Date.now() - startTs) / 1000);
        updateUI(elapsed);
    }

    function updateUI(totalSec) {
        let accT = 0, accW = 0, cur = null;
        
        for(let i=0; i < recipe.length; i++) {
            let r = recipe[i];
            let rTime = parseInt(r.time);
            if(totalSec >= accT && totalSec < accT + rTime) {
                cur = r;
                let stepElapsed = totalSec - accT;
                let timeLeftInStep = rTime - stepElapsed;

                document.getElementById('stepTimeCurrent').innerText = formatTime(stepElapsed);
                document.getElementById('stepTimeTarget').innerText = formatTime(rTime);
                
                if (i + 1 < recipe.length) {
                    let nextStep = recipe[i+1];
                    if (nextStep.method === "침출" && timeLeftInStep === 2 && warnedImmersionStart !== (i+1)) {
                        speak("스위치를 닫아주세요");
                        warnedImmersionStart = i + 1;
                    }
                }
                if (cur.method === "침출" && timeLeftInStep === 2 && warnedImmersionEnd !== i) {
                    speak("스위치를 열어주세요");
                    warnedImmersionEnd = i;
                }
                break;
            }
            accT += rTime;
            accW += parseInt(r.water);
        }

        document.getElementById('totalTime').innerText = formatTime(totalSec);

        if(cur) {
            const displayTitle = `${cur.name} (${cur.method})`;
            if(document.getElementById('curStepName').innerText !== displayTitle) {
                document.getElementById('curStepName').innerText = displayTitle;
                document.getElementById('curStepTip').innerText = cur.tip || "";
                
                // [수정] 음성 안내에 '팁' 정보 추가
                const tipText = cur.tip ? `, 팁, ${cur.tip}` : "";
                speak(`${cur.name}, ${cur.method}, ${cur.water}그램, ${cur.time}초 ${tipText}`);
                blink();
            }
            document.getElementById('curWater').innerText = cur.water + "g";
            document.getElementById('totalWater').innerText = (accW + parseInt(cur.water)) + "g";
        } else if(totalSec >= accT && recipe.length > 0 && running) {
            document.getElementById('curStepName').innerText = "추출 완료";
            document.getElementById('curStepTip').innerText = "";
            speak("추출이 완료되었습니다.");
            pauseTimer();
        }
    }

    function formatTime(s) {
        const m = Math.floor(s/60).toString().padStart(2,'0');
        const sc = (s%60).toString().padStart(2,'0');
        return `${m}:${sc}`;
    }

    function blink() { 
        let b = document.getElementById('stepBox'); 
        b.style.borderColor = "var(--accent)"; 
        setTimeout(()=>b.style.borderColor="transparent", 600); 
    }

    function switchTab(id) {
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            v.style.display = 'none';
        });
        const targetView = document.getElementById('view-'+id);
        targetView.classList.add('active');
        targetView.style.display = (id === 'timer') ? 'flex' : 'block';
        
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if(id==='timer') document.querySelectorAll('.tab-btn')[0].classList.add('active');
        if(id==='editor') { document.querySelectorAll('.tab-btn')[1].classList.add('active'); renderEditor(); renderLibrary(); }
        if(id==='logs') document.querySelectorAll('.tab-btn')[2].classList.add('active');
    }

    function renderEditor() {
        const list = document.getElementById('recipeList');
        list.innerHTML = recipe.map((r, i) => `
            <div class="recipe-item">
                <div class="recipe-row-1">
                    <input type="text" placeholder="단계명" value="${r.name}" onchange="recipe[${i}].name=this.value">
                    <select onchange="recipe[${i}].method=this.value">
                        <option value="푸어" ${r.method === '푸어' ? 'selected' : ''}>푸어</option>
                        <option value="침출" ${r.method === '침출' ? 'selected' : ''}>침출</option>
                    </select>
                    <input type="number" placeholder="물(g)" value="${r.water}" onchange="recipe[${i}].water=this.value">
                    <input type="number" placeholder="시간" value="${r.time}" onchange="recipe[${i}].time=this.value">
                    <button onclick="deleteStep(${i})" style="background:none;border:none;color:var(--danger);font-size:1.5rem;">&times;</button>
                </div>
                <div class="recipe-row-2">
                    <input type="text" placeholder="팁 (예: 천천히 부어주세요)" value="${r.tip || ''}" onchange="recipe[${i}].tip=this.value" style="text-align:left; color:var(--accent);">
                </div>
            </div>
        `).join('');
        localStorage.setItem('activeRecipe_v4', JSON.stringify(recipe));
    }

    function addStep() { 
        recipe.push({name:"추가 단계", method:"푸어", time:30, water:50, tip:""}); 
        renderEditor(); 
    }
    
    function deleteStep(i) { 
        recipe.splice(i,1); 
        renderEditor(); 
    }

    function saveToLibrary() {
        const nameInput = document.getElementById('recipeNameInput');
        const name = nameInput.value.trim();
        if(!name) { alert("레시피 이름을 입력해주세요."); return; }
        
        const existingIdx = recipeLibrary.findIndex(item => item.name === name);
        if(existingIdx >= 0) {
            if(!confirm("이미 같은 이름의 레시피가 있습니다. 덮어쓰시겠습니까?")) return;
            recipeLibrary[existingIdx].data = JSON.parse(JSON.stringify(recipe));
        } else {
            recipeLibrary.push({ name: name, data: JSON.parse(JSON.stringify(recipe)) });
        }
        
        localStorage.setItem('recipeLibrary_v4', JSON.stringify(recipeLibrary));
        alert("보관함에 저장되었습니다.");
        nameInput.value = "";
        renderLibrary();
    }

    function renderLibrary() {
        const list = document.getElementById('savedList');
        if(recipeLibrary.length === 0) {
            list.innerHTML = "<div style='color:#666; text-align:center; padding:20px;'>저장된 레시피가 없습니다.</div>";
            return;
        }
        list.innerHTML = recipeLibrary.map((item, idx) => `
            <div class="saved-item">
                <div class="saved-title">${item.name} <span style="font-size:0.8rem; color:#888;">(${item.data.length}단계)</span></div>
                <div class="saved-actions">
                    <button class="btn-load" onclick="loadRecipe(${idx})">불러오기</button>
                    <button class="btn-del" onclick="deleteRecipe(${idx})">삭제</button>
                </div>
            </div>
        `).join('');
    }

    function loadRecipe(idx) {
        if(!confirm("현재 작성 중인 레시피가 사라집니다. 불러오시겠습니까?")) return;
        recipe = JSON.parse(JSON.stringify(recipeLibrary[idx].data));
        renderEditor();
        localStorage.setItem('activeRecipe_v4', JSON.stringify(recipe));
        alert("레시피를 불러왔습니다.");
        resetTimer();
        switchTab('timer');
    }

    function deleteRecipe(idx) {
        if(!confirm("정말 삭제하시겠습니까?")) return;
        recipeLibrary.splice(idx, 1);
        localStorage.setItem('recipeLibrary_v4', JSON.stringify(recipeLibrary));
        renderLibrary();
    }

    function saveLog() {
        const bean = document.getElementById('logBean').value || "Unnamed Coffee";
        const dateStr = new Date().toLocaleString('ko-KR', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
        logs.unshift({d: dateStr, b: bean});
        localStorage.setItem('brewLogs_v4', JSON.stringify(logs));
        renderLogs(); 
        document.getElementById('logBean').value = "";
    }
    function renderLogs() {
        document.getElementById('logHistory').innerHTML = logs.map(l => `
            <div class="log-entry">
                <div style="font-size:0.8rem; color:var(--text-dim);">${l.d}</div>
                <div style="font-size:1.1rem; font-weight:bold; margin-top:4px;">${l.b}</div>
            </div>
        `).join('');
    }
    renderLogs();
</script>
</body>
</html>
